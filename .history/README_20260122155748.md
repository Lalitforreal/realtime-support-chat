# Real-Time Support Chat (HTTP + Socket.IO Auth)

A support chat system built with:
- HTTP authentication for agents
- Socket.IO authentication middleware (cookie/JWT)
- Role-based authorization inside socket events
- Ticket rooms (one room per ticket)
- Guest customer flow (no login)


## Features

### Customer (Guest)
- Create support ticket
- Auto-join ticket room
- Send/receive chat messages in real time
- Ticket tied to guest identity (guestId)

### Agent (Login Required)
- Login using HTTP route
- JWT stored in cookie
- Socket authenticates from cookie automatically
- View ticket list
- Join ticket room
- Reply and close ticket

---

## Architecture

### Auth Flow
1. Agent logs in via HTTP (/agent/login)
2. Server verifies credentials
3. Server sets cookie: token=<JWT>
4. When socket connects, the cookie is sent automatically
5. Socket middleware verifies JWT once and attaches:
   - socket.data.userId
   - socket.data.role
   - socket.data.name

Socket auth happens once at connect time (not on every event).

---

## Tech Stack
- Node.js + Express
- Socket.IO
- JWT
- cookie-parser
- MongoDB (for tickets, admin credentials)

---

## Project Checklist (Build Order)

### Phase 0: Setup
- [ ] Init Node project (npm init -y)
- [ ] Install dependencies
  - [ ] express
  - [ ] socket.io
  - [ ] jsonwebtoken
  - [ ] cookie-parser
  - [ ] dotenv
- [ ] Setup folder structure
- [ ] Setup .env file

---

### Phase 1: Agent Auth (HTTP)
- [ ] Create agent login page (frontend)
- [ ] Create POST /agent/login route
- [ ] Verify credentials (hardcoded or DB)
- [ ] Generate JWT payload:
  - [ ] id
  - [ ] role: "agent"
  - [ ] name
- [ ] Set cookie token=<JWT> (httpOnly)
- [ ] Protect /agent/dashboard via middleware
- [ ] Logout route (/agent/logout)

---

### Phase 2: Socket Authentication Middleware
- [ ] Create Socket.IO server using same HTTP server
- [ ] Parse cookie inside socket handshake
- [ ] Extract JWT from cookie
- [ ] Verify JWT
- [ ] Attach user info to socket:
  - [ ] socket.data.userId
  - [ ] socket.data.role
  - [ ] socket.data.name
- [ ] If no token, set guest mode:
  - [ ] socket.data.role = "guest"

---

### Phase 3: Ticket System
- [ ] Create ticket model/schema:
  - [ ] ticketId
  - [ ] customerId (guestId)
  - [ ] status: open/closed
  - [ ] createdAt
- [ ] Customer event: ticket:create
  - [ ] Generate ticket
  - [ ] Store ticket
  - [ ] Auto-join room: ticket:<id>
- [ ] Agent event: ticket:list
  - [ ] Return all open tickets

---

### Phase 4: Authorization Rules
- [ ] Agent-only event protection:
  - [ ] ticket:list
  - [ ] ticket:join
  - [ ] ticket:close
- [ ] Ticket ownership checks:
  - [ ] Customer can only join their own ticket
  - [ ] Agent can join any ticket

Never accept role from the client. Role is derived from JWT/cookie on the server.

---

### Phase 5: Chat Messaging (Room Based)
- [ ] Event: chat:message
  - [ ] Validate ticket
  - [ ] Check access rules
  - [ ] Broadcast to ticket room
- [ ] Store messages (recommended):
  - [ ] ticketId
  - [ ] senderId
  - [ ] senderRole
  - [ ] text
  - [ ] timestamp

---

### Phase 6: Ticket Closing and Archive
- [ ] Agent event: ticket:close
- [ ] Update status to closed
- [ ] Notify customer (emit event)
- [ ] Prevent messaging on closed tickets

---

## Optional Enhancements
- [ ] Reconnection handling
- [ ] Typing indicator
- [ ] Read receipts
- [ ] Ticket assignment
- [ ] Admin panel (agent creation)
- [ ] Rate limit protection
- [ ] Message validation/profanity filter

---

## Socket Event Design

### Customer Events
- ticket:create
- chat:message
- room:leave

### Agent Events
- ticket:list
- ticket:join
- ticket:close
- chat:message

Role is never sent from the client. The server assigns it from authentication.

---

## Suggested Folder Structure